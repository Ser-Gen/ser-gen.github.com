[Статья опубликована](http://habrahabr.ru/post/180615/)


# Ещё один способ устранить ВОШ

## Задача

_ВОШ_ (Вспышка Обычного Шрифта) — эффект, возникающий при стилизации текста подключаемым шрифтом, не установленным на компьютере пользователя. Проявляется при загрузке страницы, когда текст сначала _отображается обычным шрифтом_, а потом уже _отображается нестандартным_. Такое переключение шрифтов также может повлиять на размеры элемента, если они зависят от размеров текста в нём.
Эффект известен также как _FOUT_ (Flash Of Unstyled Text) — так его [назвал](http://paulirish.com/2009/fighting-the-font-face-fout/) Пол Айриш.

При общих моментах, есть и особенности. Например, в Файрфоксе текст, который нужно будет отрисовать нестандартным шрифтом, [в течение 3 секунд](https://bugzilla.mozilla.org/show_bug.cgi?id=499292) не отображается, в Хроме [тоже есть подобная задержка](https://bugs.webkit.org/show_bug.cgi?id=25207#c28). Если шрифт успеет скачаться за это время, текст отобразится сразу нужным шрифтом.

На эту тему здесь была [такая статья](http://habrahabr.ru/post/78551/). В ней последствия ВОШ рекомендовалось нивелировать грамотной игрой со шрифтами. К сожалению, иногда подключаются такие шрифты, которые слишком отличаются по характеристикам от стандартных.


<--------------------------------------->


## Решение

Чтобы устранить ВОШ, я решил указывать шрифт в основном файле стилей при помощи `data uri`, чтобы шрифт отображался сразу, вместе со страницей.

Остаётся выбрать формат шрифта, понимаемый большинством браузеров посетителей и удобный для загрузки. Широту поддержки форматов подключаемых шрифтов можно узнать [здесь](http://caniuse.com/#feat=fontface).

Шрифты в `eot` наиболее лёгкие, но поддерживаются только ИЕ.
Шрифты в `ttf` и `svg` тяжелы, иногда — конечно, это зависит от шрифта — занимающие в два раза больше места, чем `eot` и `woff`. В моей ситуации я выбрал `woff`, этот формат поддерживается большинством браузеров наших посетителей.
Ещё есть браузеры, которые `woff` не понимают, поэтому указываются альтернативы для них.

ИЕ версии 8 и старше не понимают шрифты в `woff`, им нужен `eot`. В то же время, ИЕ8 не понимает файлы в data:uri [тяжелее 32КБ](http://css-tricks.com/data-uris/), а более старшие версии не воспринимают совсем никакие, поэтому в отдельном файле стилей для них можно указать просто ссылки на файлы шрифтов. Чтобы эти браузеры не загружали ненужное, подключение шрифта в `woff` и в других форматах выделено в отдельный файл стилей и отделено условным комментарием.

Также, есть мнение, что [под вин в хроме `svg`-шрифты выглядят лучше других](http://www.fontspring.com/demos/svg-vs-woff/), но, мне кажется, это дело вкуса. Шрифт в этом формате [лучше других сжимается](http://www.phpied.com/gzip-your-font-face-files/) при помощи `gzip`, но не поддерживается Файрфоксами и ИЕ.

Таким образом, подгружать шрифты можно при помощи следующего кода

  <!-- подключение файлов стилей -->
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="fonts_ie.css" media="all">
  <![endif]-->
  <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="fonts.css" media="all">
  <!--<![endif]-->

  <link rel="stylesheet" href="main.css" media="all">


  /* fonts_ie.css */
  @font-face {
    font-family: 'PT Sans Narrow';
    font-style: italic;
    font-weight: bold;
    src: url('PTS76F_W.eot');
  }

  /* fonts.css */
  @font-face {
    font-family: 'PT Sans Narrow';
    font-style: italic;
    font-weight: bold;
    font-variant: normal;
    src: url('data:application/x-font-woff;base64,d09GRgABAAAA...aCw0AAA==') format('woff'), 
         url('PTN77F_W.svg#PTSans-NarrowBold') format('svg'),
         url('PTN77F_W.ttf') format('truetype');
  }

  /* main.css */
  body {
    font-family: 'PT Sans Narrow', 'Arial Narrow', sans-serif;
    font-style: italic;
  }


При использовании этого способа ВОШ остаётся только в неподдерживающих `woff`-шрифты, планомерно теряющих пользователей браузерах, самый распространённый из которых на данный момент — ИЕ8.

[На этой странице шрифт подключен традиционно](http://ser-gen.github.io/sandbox/tests/fout/test_1.html)
[Здесь шрифт закодирован](http://ser-gen.github.io/sandbox/tests/fout/test_2.html)
Эффект заметней на медленном соединении.


## Особенности

Стоит осознать, что при использовании такой техники остаются браузеры, которые не понимают шрифты в `woff`, но которым придётся их загружать. Тут уже играет роль количество посетителей с такими браузерами и продуктивность их посещений. В моей ситуации оказалось, что лучше устранить ВОШ.

Шрифт всё равно будет скачиваться, даже если установлен локально. Это сделано, чтобы предотвратить конфликты между начертаниями; будет скачиваться такое, какое нужно.
Страница [не будет отрисовываться](http://www.phpied.com/css-and-the-critical-path/), пока файл стилей со шрифтом не скачается.

Также отмечу, что **способ не подойдёт для шрифтов с лицензией, не позволяющей загружать их при помощи `data:uri`**.

И, конечно, гарантированное решение всех проблем с подгружаемыми шрифтами — **отказаться** от их использования. Серьёзно, иногда они ни к чему.


## Дополнительная информация

[Отличная отправная точка для изучения темы подключаемых шрифтов](http://habrahabr.ru/post/64596/)
[Если нужно подключить шрифт как обычно](http://habrahabr.ru/post/113136/). [Здесь же](http://habrahabr.ru/post/113136/#comment_3634868) находится комментарий, который я заметил уже после того, как применил этот способ.
[Немного об особенностях подключения](http://paulirish.com/2010/font-face-gotchas/)


#html, #css, @font-face, data:uri, подключаемый шрифт, FOUT, ВОШ





[Ещё на тему нестандартных шрифтов](http://paulirish.com/2009/bulletproof-font-face-implementation-syntax/)
и [вот](http://paulirish.com/2009/fighting-the-font-face-fout/);
[общие моменты](http://www.html5rocks.com/en/tutorials/webfonts/quick/)
[Шрифты можно гзиповать](http://www.phpied.com/gzip-your-font-face-files/)
[Ещё об этом](http://www.phpied.com/font-face-gzipping-take-ii/)



<blockquote>К тому же, вы даете гарантию, что разработчик, который будет поддерживать код после вас, поймет ваши пляски со шрифтами?</blockquote>
Если это не знакомый мне разработчик, гарантию не дам :)
Но способ задокументирую и уверен, что всё будет хорошо.

<blockquote>данная техника порочна, так как является не нужной оптимизацией и увеличивает размер страницы. Всегда есть вещи, которые можно было бы оптимизировать, чтобы извлечь бОльшую выгоду, чем от данного способа. Например, объединение картинок в спрайты, загрузка шрифтов до скриптов или объединение скриптов в один файл</blockquote>
Вообще, подключаемые шрифты увеличивают размер страницы сами по себе, а в этой статье я пишу только про эффект, с ними связанный.
Своим методом я не отменяю необходимость оптимизации других аспектов. Конечно, всё это — и даже больше — нужно делать, вырезать неиспользуемые символы в том числе.

Для примера к статье я использовал PT Sans Narrow с большим количеством символов, которые я, скорее всего, никогда не буду использовать. Но ничего не мешает мне на реальном сайте их все вырезать, как вы описали.

К тому же, как верно <a href="http://habrahabr.ru/post/180615/#comment_6276265">отметили</a> ниже, <code>gzip</code> делает свою работу хорошо.







[Про псевдопроблему с WOFF в Опере](https://www.free-lance.ru/commune/professionalnyie/129/htmlcss/1438148/dopolnenie-pro-font-face-i-opera.html)

— Насчёт Flash Of Unstyled Text
Почему Unstyled? Например, когда на у пользователя нет Тахомы, а текст отобразился просто шрифтом без засечек, который был указан следом за ним в правиле, при этом он раскрашен в нужный цвет, отображён нужным кеглем, он же стилизован.

[Грамотное подключение нескольких начертаний](http://www.metaltoad.com/blog/how-use-font-face-avoid-faux-italic-and-bold-browser-styles)

— Весь сыр-бор только из-за самой первой загрузки. Если всё сделано правильно, все ресурсы надолго закешируются и обо всех проблемах со шрифтами думать совсем не нужно будет!






Для ИЕ использовать шрифты в `data uri` невозможно, ведь размер загружемого таким способом ресурса [не может быть больше 32КБ](http://caniuse.com/datauri), шрифты в формате `eot`, пригодном для использования ИЕ, тяжелы, поэтому используется самый лёгкий формат — `woff`, а для ИЕ отдельно подключаются внешние файлы.

Есть возможность сгладить последствия этой проблемы — вынести шрифт в отдельный файл стилей и подключать его отдельно от неподдерживающих его версий ИЕ. Тогда загружать ненужное будут старые версии неИЕ-обозревателей, которые быстро сменяются новыми, поддерживающими версиями. Ещё лучше с точки зрения отсутствия загрузки лишнего будет формировать таблицу стилей индивидуально для каждого юзер-агента, но и этот способ имеет свои недостатки (избыточность для некоторых проектов, кто-то может менять юзерагент) и, иногда, труднореализуем.
Необходимо устанавливать настройки шрифта [из-за вебкита](http://paulirish.com/2010/font-face-gotchas/).

[Оригинал предыдущей статьи](http://paulirish.com/2009/bulletproof-font-face-implementation-syntax/).



// Исправить про свг и ттф про размер, изменить положение этого абзаца
Проблема этого способа в том, что ещё есть браузеры, которые не понимают такой формат, всё равно загружают его. Конечно, есть формат `ttf`, который понимают практически все, кроме ИЕ<9. Но проблема этого формата в том, что шрифты в нём имеют в два раза больший размер; нет смысла заставлять всех грузить в два раза больший шрифт, который понимает меньшее количество браузеров посетителей.

Гарантированное решение — **отказаться** от использования нестандартных шрифтов. Серьёзно, иногда они ни к чему.

================================================

Возможно, кто-то уже давно использует такой способ подключения шрифтов (или даже лучший), но он мне на глаза не попадался.
